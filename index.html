<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸¸å¤ªæ¤œçŸ¥ Voskç‰ˆ</title>
    
    <script src="coi-serviceworker.js"></script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#8b4513">
    
    <script type="application/javascript" src="https://cdn.jsdelivr.net/npm/vosk-browser@0.0.9/dist/vosk.js"></script>

    <style>
        /* UIãƒ‡ã‚¶ã‚¤ãƒ³ã¯ä»¥å‰ã®ã¾ã¾ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãªã©ã‚’å¼·åŒ– */
        body { font-family: -apple-system, sans-serif; padding: 15px; background: #fdf5e6; color: #333; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        .header-area { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #8b4513; margin-bottom: 15px; padding-bottom: 5px; }
        h2 { margin: 0; font-size: 1.1em; color: #5d4037; }

        /* éŸ³å£°ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç”¨ */
        #voiceStatus { 
            font-size: 0.9em; color: white; background: #9e9e9e; 
            padding: 8px 15px; border-radius: 20px; margin-bottom: 15px; 
            text-align: center; font-weight: bold; transition: background 0.3s;
        }
        .status-ready { background: #2e7d32 !important; } /* æº–å‚™OK */
        .status-listening { background: #d32f2f !important; animation: pulse 1.5s infinite; } /* èãå–ã‚Šä¸­ */
        .status-loading { background: #ff9800 !important; } /* ãƒ¢ãƒ‡ãƒ«ãƒ­ãƒ¼ãƒ‰ä¸­ */

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        .input-row { margin-bottom: 12px; }
        .label-group { display: flex; align-items: baseline; margin-bottom: 4px; }
        .label-group label { width: 130px; font-size: 0.9em; font-weight: bold; color: #5d4037; }
        
        input, select {
            width: 100%; padding: 10px; border: 1px solid #d7ccc8; border-radius: 6px;
            font-size: 16px; box-sizing: border-box; background-color: white; height: 44px;
        }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
        button { flex: 1; padding: 14px; font-size: 15px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; }
        .voice-btn { background: #8b4513; }
        .save-btn { background: #5d4037; }
        
        .log-area { font-size: 0.8em; color: #666; margin-top: 10px; height: 60px; overflow-y: auto; background: #eee; padding: 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="card">
    <div class="header-area">
        <h2>ğŸŒ² ä¸¸å¤ªæ¤œçŸ¥ (Vosk)</h2>
    </div>

    <div id="voiceStatus" class="status-loading">ãƒ¢ãƒ‡ãƒ«èª­è¾¼ä¸­...</div>
    
    <div class="input-row">
        <div class="label-group"><label>æ¨¹ç¨®</label></div>
        <select id="treeType">
            <option value="ã‚¹ã‚®">ã‚¹ã‚®</option>
            <option value="ãƒ’ãƒã‚­">ãƒ’ãƒã‚­</option>
            <option value="ä»–é‡">ä»–é‡è‘‰æ¨¹</option>
            <option value="ä»–åºƒ">ä»–åºƒè‘‰æ¨¹</option>
        </select>
    </div>

    <div class="input-row">
        <div class="label-group"><label>æé•· (m)</label></div>
        <input type="number" step="0.1" id="length" value="4">
    </div>

    <div class="input-row">
        <div class="label-group"><label>æœ«å£ç›´å¾„ (cm)</label></div>
        <input type="number" step="2" id="diameter">
    </div>

    <div class="input-row">
        <div class="label-group"><label>æè³ª (A/B/C)</label></div>
        <select id="quality">
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
        </select>
    </div>

    <div class="input-row">
        <div class="label-group"><label>å‚™è€ƒ</label></div>
        <input type="text" id="memo">
    </div>

    <div class="btn-group">
        <button id="voiceBtn" class="voice-btn" onclick="toggleVoice()" disabled>éŸ³å£°å…¥åŠ› é–‹å§‹</button>
        <button class="save-btn" onclick="saveData()">ä¿å­˜</button>
    </div>
    
    <div class="log-area" id="debugLog">ãƒ­ã‚°: </div>
</div>

<script>
    // --- è¨­å®šï¼šVoskãƒ¢ãƒ‡ãƒ«ã¨èªè­˜å˜èª ---
    // GitHubãƒªãƒã‚¸ãƒˆãƒªã® "model" ãƒ•ã‚©ãƒ«ãƒ€ã‚’æŒ‡å®š
    const MODEL_URL = './model'; 
    
    // â˜…é‡è¦ï¼šã“ã“ã«ã‚ã‚‹å˜èªã€Œã—ã‹ã€èªè­˜ã—ã¾ã›ã‚“ã€‚ã“ã‚Œã§ç²¾åº¦ã‚’çˆ†ä¸Šã’ã—ã¾ã™ã€‚
    const WORD_LIST = [
        "ã™ã", "ã²ã®ã", "ã»ã‹ã—ã‚“ã‚ˆã†ã˜ã‚…", "ã»ã‹ã“ã†ã‚ˆã†ã˜ã‚…",
        "ã¡ã‚‡ã£ã‘ã„", "ãŸã‹ã•", "ãªãŒã•", "ã–ã„ã—ã¤", "ã‚ã‚‚",
        "ãˆãƒ¼", "ã³ãƒ¼", "ã—ãƒ¼", "ã¾ãŒã‚Š", "ãã•ã‚Œ", "ãã¾ã¯ã",
        "ã»ãã‚“", "ã¨ã‚Šã‘ã—",
        "ã„ã¡", "ã«", "ã•ã‚“", "ã‚ˆã‚“", "ã”", "ã‚ã", "ãªãª", "ã¯ã¡", "ãã‚…ã†", "ã˜ã‚…ã†", 
        "ã²ã‚ƒã", "ã¦ã‚“", "ã¾ã‚‹", "ãœã‚"
    ];

    let recognizer = null;
    let audioContext = null;
    let mediaStream = null;
    let processor = null;
    let isListening = false;

    const statusEl = document.getElementById('voiceStatus');
    const logEl = document.getElementById('debugLog');
    const voiceBtn = document.getElementById('voiceBtn');

    // ãƒ­ã‚°å‡ºåŠ›ç”¨
    function log(msg) {
        logEl.innerText = msg + "\n" + logEl.innerText;
        console.log(msg);
    }

    // åˆæœŸåŒ–ï¼šãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰
    window.onload = async () => {
        try {
            log("ãƒ¢ãƒ‡ãƒ«èª­è¾¼é–‹å§‹(50MB)...Wifiæ¨å¥¨");
            
            // Voskãƒ¢ãƒ‡ãƒ«ã®ä½œæˆ
            const model = await Vosk.createModel(MODEL_URL);
            
            // ãƒªã‚³ã‚°ãƒŠã‚¤ã‚¶ãƒ¼ã®ä½œæˆï¼ˆæ–‡æ³•ã‚’æŒ‡å®šï¼‰
            recognizer = new model.KaldiRecognizer(48000);
            recognizer.setGrammar(JSON.stringify(WORD_LIST));
            
            // æº–å‚™å®Œäº†
            statusEl.innerText = "éŸ³å£°å…¥åŠ›ï¼šå¾…æ©Ÿä¸­";
            statusEl.className = "status-ready";
            voiceBtn.disabled = false;
            voiceBtn.innerText = "éŸ³å£°å…¥åŠ› é–‹å§‹";
            log("ãƒ¢ãƒ‡ãƒ«èª­è¾¼å®Œäº†ï¼æº–å‚™OK");

        } catch (e) {
            log("ã‚¨ãƒ©ãƒ¼: " + e);
            statusEl.innerText = "èª­è¾¼ã‚¨ãƒ©ãƒ¼";
            statusEl.style.background = "black";
        }
    };

    // éŸ³å£°èªè­˜ã®é–‹å§‹ãƒ»åœæ­¢
    async function toggleVoice() {
        if (!isListening) {
            startListening();
        } else {
            stopListening();
        }
    }

    async function startListening() {
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            mediaStream = await navigator.mediaDevices.getUserMedia({
                video: false,
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    channelCount: 1,
                    sampleRate: 48000
                }
            });

            const source = audioContext.createMediaStreamSource(mediaStream);
            
            // AudioWorkletã‚’ä½¿ã£ã¦ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã›ãšã«å‡¦ç†
            await audioContext.audioWorklet.addModule('https://cdn.jsdelivr.net/npm/vosk-browser@0.0.9/dist/vosk-deploy.js');
            processor = new AudioWorkletNode(audioContext, 'vosk-processor', {
                processorOptions: {
                    recognizer: recognizer
                }
            });

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡ï¼ˆèªè­˜çµæœï¼‰
            processor.port.onmessage = (event) => {
                const result = event.data;
                if (result.result && result.result.text) {
                    const text = result.result.text;
                    log("èªè­˜: " + text);
                    parseCommand(text); // ã‚³ãƒãƒ³ãƒ‰è§£æã¸
                }
            };

            source.connect(processor);
            processor.connect(audioContext.destination);

            isListening = true;
            statusEl.innerText = "èã„ã¦ã„ã¾ã™...";
            statusEl.className = "status-listening";
            voiceBtn.innerText = "éŸ³å£°å…¥åŠ› åœæ­¢";

        } catch (e) {
            log("ãƒã‚¤ã‚¯èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e);
        }
    }

    function stopListening() {
        if (mediaStream) mediaStream.getTracks().forEach(track => track.stop());
        if (audioContext) audioContext.close();
        isListening = false;
        statusEl.innerText = "éŸ³å£°å…¥åŠ›ï¼šå¾…æ©Ÿä¸­";
        statusEl.className = "status-ready";
        voiceBtn.innerText = "éŸ³å£°å…¥åŠ› é–‹å§‹";
    }

    // --- ã‚³ãƒãƒ³ãƒ‰è§£æãƒ­ã‚¸ãƒƒã‚¯ ---
    function parseCommand(text) {
        // ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
        text = text.replace(/\s+/g, '');

        // 1. ä¿å­˜ãƒ»å–æ¶ˆ
        if (text.includes("ã»ãã‚“")) { saveData(); return; }
        if (text.includes("ã¨ã‚Šã‘ã—")) { document.getElementById('diameter').value = ""; return; }

        // 2. æ¨¹ç¨®
        if (text.includes("ã™ã")) setVal('treeType', 'ã‚¹ã‚®');
        else if (text.includes("ã²ã®ã")) setVal('treeType', 'ãƒ’ãƒã‚­');
        else if (text.includes("ã»ã‹ã—ã‚“ã‚ˆã†ã˜ã‚…")) setVal('treeType', 'ä»–é‡');
        else if (text.includes("ã»ã‹ã“ã†ã‚ˆã†ã˜ã‚…")) setVal('treeType', 'ä»–åºƒ');

        // 3. æè³ª
        if (text.includes("ã–ã„ã—ã¤")) {
            if (text.includes("ãˆãƒ¼")) setVal('quality', 'A');
            if (text.includes("ã³ãƒ¼")) setVal('quality', 'B');
            if (text.includes("ã—ãƒ¼")) setVal('quality', 'C');
        }

        // 4. ãƒ¡ãƒ¢
        if (text.includes("ã‚ã‚‚")) {
            let memoVal = "";
            if (text.includes("ã¾ãŒã‚Š")) memoVal = "æ›²ãŒã‚Š";
            if (text.includes("ãã•ã‚Œ")) memoVal = "è…ã‚Œ";
            if (text.includes("ãã¾ã¯ã")) memoVal = "ã‚¯ãƒå‰¥ã";
            if (memoVal) document.getElementById('memo').value = memoVal;
        }

        // 5. æ•°å­—ç³»ï¼ˆç›´å¾„ãƒ»é•·ã•ãƒ»é«˜ã•ï¼‰
        // æ•°å­—ã‚’æŠ½å‡ºã—ã¦ã‚¢ãƒ©ãƒ“ã‚¢æ•°å­—ã«å¤‰æ›
        const numVal = extractNumber(text);

        if (numVal !== null) {
            if (text.includes("ã¡ã‚‡ã£ã‘ã„")) {
                document.getElementById('diameter').value = numVal;
            } else if (text.includes("ãªãŒã•") || text.includes("ãŸã‹ã•")) {
                document.getElementById('length').value = numVal;
            }
        }
    }

    // æ¼¢æ•°å­—éŸ³å£° â†’ æ•°å€¤å¤‰æ›ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    function extractNumber(text) {
        // ã¾ãšä¸è¦ãªæ–‡å­—ã‚’æ¶ˆã™ï¼ˆã‚³ãƒãƒ³ãƒ‰éƒ¨åˆ†ï¼‰
        let numStr = text.replace(/ã¡ã‚‡ã£ã‘ã„|ãªãŒã•|ãŸã‹ã•|ã–ã„ã—ã¤|ã‚ã‚‚|ã§ã™|ã¾ã™/g, "");
        
        // å¤‰æ›ãƒãƒƒãƒ—
        const map = {
            "ãœã‚":0, "ã¾ã‚‹":0, "ã„ã¡":1, "ã«":2, "ã•ã‚“":3, "ã‚ˆã‚“":4, "ã”":5,
            "ã‚ã":6, "ãªãª":7, "ã¯ã¡":8, "ãã‚…ã†":9, "ã¦ã‚“": "."
        };

        // é€£ç¶šã™ã‚‹æ•°å­—ã‚’è§£æ
        // ä¾‹ï¼šã€Œã« ã˜ã‚…ã† ã”ã€â†’ 25ã€ã€Œã•ã‚“ ã¦ã‚“ ã‚ãã€â†’ 3.6
        // Vosk Smallãƒ¢ãƒ‡ãƒ«ã¯ã€ŒäºŒåäº”ã€ã¨æ¼¢å­—ã§å‡ºã™å ´åˆã¨ã€Œã« ã˜ã‚…ã† ã”ã€ã¨å‡ºã™å ´åˆãŒã‚ã‚‹
        // ã“ã“ã§ã¯ Grammar ã§æŒ‡å®šã—ãŸã²ã‚‰ãŒãªãƒªã‚¹ãƒˆã‚’ãƒ™ãƒ¼ã‚¹ã«ç°¡å˜ãªçµåˆãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
        
        let result = 0;
        let temp = 0;
        let isDecimal = false;
        let decimalPlace = 0.1;
        let foundNum = false;

        // æ–‡å­—åˆ—ã‚’1æ–‡å­—ãšã¤ã€ã‚ã‚‹ã„ã¯æ—¢çŸ¥ã®å˜èªã§ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã®ãŒç†æƒ³ã ãŒã€
        // ç°¡æ˜“çš„ã«æ–‡å­—åˆ—ç½®æ›ã§ã‚¢ãƒ©ãƒ“ã‚¢æ•°å­—åˆ—ã‚’ä½œã‚‹
        let arabStr = numStr;
        for (const [key, val] of Object.entries(map)) {
            arabStr = arabStr.split(key).join(val);
        }
        
        // ã€Œã˜ã‚…ã†ã€ã®å‡¦ç†ï¼ˆ10ã€œ99ï¼‰
        arabStr = arabStr.replace(/(\d)?ã˜ã‚…ã†(\d)?/g, (match, p1, p2) => {
            let n1 = p1 ? parseInt(p1) : 1;
            let n2 = p2 ? parseInt(p2) : 0;
            return (n1 * 10 + n2).toString();
        });
        
        // ã€Œã²ã‚ƒãã€ã®å‡¦ç†
        arabStr = arabStr.replace(/(\d)?ã²ã‚ƒã(\d+)?/g, (match, p1, p2) => {
             let n1 = p1 ? parseInt(p1) : 1;
             let n2 = p2 ? parseInt(p2) : 0;
             return (n1 * 100 + n2).toString();
        });

        // å°‘æ•°ç‚¹ã®çµåˆãªã©ã®ã‚´ãƒŸæƒé™¤ã‚’ã—ã¦æ•°å€¤åŒ–
        const finalNum = parseFloat(arabStr.replace(/[^\d.]/g, ''));
        
        return isNaN(finalNum) ? null : finalNum;
    }

    function setVal(id, val) {
        document.getElementById(id).value = val;
        // å¤‰æ›´ã‚’è¦–è¦šçš„ã«é€šçŸ¥ï¼ˆé»„è‰²ããƒ•ãƒ©ãƒƒã‚·ãƒ¥ï¼‰
        const el = document.getElementById(id);
        el.style.backgroundColor = "#fff9c4";
        setTimeout(() => el.style.backgroundColor = "white", 500);
    }

    function saveData() {
        const d = document.getElementById('diameter').value;
        if(!d) { alert("ç›´å¾„ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        alert(`ä¿å­˜ã—ã¾ã—ãŸ: ${d}cm`);
        // ã“ã“ã«æœ¬æ¥ã®ä¿å­˜å‡¦ç†ã‚’å…¥ã‚Œã‚‹
        document.getElementById('diameter').value = "";
        document.getElementById('memo').value = "";
    }
</script>
</body>
</html>
